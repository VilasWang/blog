---
title: FileZilla 内网穿透配置指南
categories:
  - 系统运维管理
  - Windows服务管理
tags:
  - Windows
description: 详细介绍使用Filezilla Server和花生壳实现内网穿透的技术实现、配置方法、最佳实践等内容。
author: vilas
abbrlink: 2acf74bd
date: 2025-12-09 12:59:14
---

### 🛠️ 详细配置步骤

#### 1. 安装与配置FileZilla Server

- **下载与安装**
  在您的内网服务器上，从FileZilla官网下载FileZilla Server并安装。
  > **注意**: 本指南基于 FileZilla Server 经典版本 (0.9.x) 的界面描述。如果您使用的是 1.x 或更高版本，管理界面可能有所不同（通常为基于Web的仪表板），但核心配置概念（用户、被动模式端口）是通用的。

  安装过程中，如果弹出“连接到服务器”配置界面，通常使用默认设置（如主机名`127.0.0.1`，管理端口）即可，点击“连接”或“确定”。

- **创建用户与设置密码**
  安装完成后，在FileZilla Server管理界面中：
  - 点击 **Edit** -> **Users** 进入用户设置。
  - 在 **General**（通用）页面，点击 **Add** 按钮创建新用户（例如 `user1`）。
  - 为该用户设置密码。

- **设置共享文件夹**
  创建用户后，系统通常会提示需设置至少一个共享文件夹。
  - 在 **Shared folders** 页面，点击 **Add** 按钮，选择您希望外网能访问下载文件的内网目录。
  - 根据需要，在 **Files** 和 **Directories** 下为用户设置目录的读取（可下载）、写入、删除等权限。至少需要开启**读取**权限，才能允许文件下载。

#### 2. 配置花生壳内网穿透

- **安装花生壳并添加映射**
  在内网服务器下载、安装并登录花生壳客户端。
  - 在花生壳客户端的 **内网穿透** 页面，点击 **+** 按钮添加映射。
  - **应用名称**：可自定义，如"FTP-Control"。
  - **应用类型**：选择 **TCP**。
  - **内网主机IP**：填写运行FileZilla Server的内网服务器IP地址（通常是`192.168.x.x`形式的地址）。**注意**：不要使用`localhost`或`127.0.0.1`。
  - **内网端口**：填写FTP服务的控制端口，默认为 **21**。
  - 点击保存，花生壳会生成一个FTP控制通道的外网访问地址（包含域名和端口）。

#### 3. 配置FTP被动模式与数据传输端口

FTP协议使用**21端口**建立控制连接，使用**被动模式下的其他端口**进行数据传输。因此，必须单独映射数据传输端口。

- **在花生壳中映射数据端口**
  按照上述同样方法，在花生壳中为FTP被动模式端口再添加一条映射：
  - **应用名称**：可自定义，如"FTP-Data"。
  - **应用类型**：**TCP**。
  - **内网主机IP**：与上一步相同。
  - **内网端口**：可**任意填写一个未占用的端口号**，例如 `12345`。
  - 保存后，花生壳会生成第二个外网访问地址，**请记下这个新地址的外网端口号**（例如 `10418`），下一步需要用到。

  添加映射后，可能需要**编辑这条映射**，将 **内网端口** 修改为与花生壳生成的 **外网端口一致**（例如将内网端口从`12345`改为`10418`），以确保数据通道正常传输。

- **在FileZilla Server中设置被动模式**
  现在需要在FileZilla Server中告知它使用这个映射好的端口。
  - 打开FileZilla Server，点击 **Edit** -> **Settings**，进入 **Passive mode settings** (被动模式设置)。
  - 勾选 **Use custom port range** (使用自定义端口范围)。
  - 在输入框中，**填写花生壳为数据通道生成的外网端口号**（例如上一步的 `10418`）。如果只使用单个端口，起始和结束端口填相同的即可。
  - **关键步骤**：在 **Use the following IP** 下方，可能需要填写花生壳生成的外网访问**域名**（即FTP控制通道的域名）。这能确保FTP服务器将正确的地址告知外网客户端。

#### 4. 设置Windows防火墙

如果内网服务器的Windows防火墙已开启，需要放行FileZilla Server相关端口。
- 在 **Windows Defender 防火墙** 中，添加入站规则。
- 允许之前用到的端口（如控制端口`21`和您在花生壳设置的数据端口`10418`）的TCP连接。

#### 5. 外网连接测试

在另一台外网电脑上，使用任何FTP客户端（如FileZilla Client）进行测试。
- **主机/地址**：填写花生壳为**控制通道**生成的外网访问地址（域名和端口，例如 `xxxx.vicp.cc:21` 处的端口）。
- **用户名与密码**：填写您在FileZilla Server中设置的账号（如 `user1`）和密码。
- **传输模式**：在FTP客户端的站点设置中，**传输模式请选择“被动模式”**。
- 连接成功后，您应该能看到内网共享的文件并可进行下载。

### 💡 关键配置提醒与排查

- **核心原理**：成功的关键在于理解FTP需要**两个通道**（控制+数据），并正确配置**被动模式**及对应的**端口映射**。
- **域名与IP**：在FileZilla Server的被动模式设置中，"Use the following IP"处建议填写花生壳生成的**域名**，而非IP地址。
- **防火墙**：确保内网服务器的防火墙不会阻挡连接。
- **花生壳版本**：免费版花生壳通常支持添加2条映射，刚好满足FTP控制与数据通道的需求。如果数据端口不理想，可以删除映射后重新添加。
