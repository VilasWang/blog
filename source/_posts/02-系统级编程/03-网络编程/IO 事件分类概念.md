---
title: IO äº‹ä»¶åˆ†ç±»æ¦‚å¿µ
categories:
  - ç³»ç»Ÿçº§ç¼–ç¨‹
tags:
  - æŠ€æœ¯æ–‡æ¡£
  - æŒ‡å—
abbrlink: ecdf807f
date: 2025-12-09 14:09:55
---

# IO äº‹ä»¶åˆ†ç±»æ¦‚å¿µ
> **æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-11-14
> **æœ€åæ›´æ–°**: 2025-11-14
> **æ ‡ç­¾**: `io`, `events`, `networking`, `system-programming`, `poll`, `epoll`

## ğŸ“‘ ç›®å½•

- [1. æ¦‚è¿°](#1-æ¦‚è¿°)
- [2. I/O äº‹ä»¶ç±»å‹](#2-io-äº‹ä»¶ç±»å‹)
  - [2.1 ç½‘ç»œI/Oäº‹ä»¶](#21-ç½‘ç»œioäº‹ä»¶)
  - [2.2 æ–‡ä»¶I/Oäº‹ä»¶](#22-æ–‡ä»¶ioäº‹ä»¶)
  - [2.3 è®¾å¤‡I/Oäº‹ä»¶](#23-è®¾å¤‡ioäº‹ä»¶)
  - [2.4 å®šæ—¶å™¨äº‹ä»¶](#24-å®šæ—¶å™¨äº‹ä»¶)
  - [2.5 ä¿¡å·äº‹ä»¶](#25-ä¿¡å·äº‹ä»¶)
- [3. ç½‘ç»œç¼–ç¨‹ä¸­çš„I/Oäº‹ä»¶](#3-ç½‘ç»œç¼–ç¨‹ä¸­çš„ioäº‹ä»¶)
- [4. äº‹ä»¶å¤„ç†æœ€ä½³å®è·µ](#4-äº‹ä»¶å¤„ç†æœ€ä½³å®è·µ)

---

## 1. ğŸ“– æ¦‚è¿°

åœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼ŒI/Oï¼ˆè¾“å…¥/è¾“å‡ºï¼‰äº‹ä»¶æ˜¯ç³»ç»Ÿé€šçŸ¥ç¨‹åºæŸä¸ª I/O æ“ä½œçŠ¶æ€å˜åŒ–çš„æœºåˆ¶ã€‚æ­£ç¡®ç†è§£å’Œåˆ†ç±»è¿™äº›äº‹ä»¶å¯¹äºé«˜æ•ˆçš„ç½‘ç»œç¼–ç¨‹è‡³å…³é‡è¦ã€‚

---

## 2. ğŸ”§ I/O äº‹ä»¶ç±»å‹

### 2.1 ğŸŒ ç½‘ç»œI/Oäº‹ä»¶

ç½‘ç»œç¼–ç¨‹ä¸­æœ€å¸¸è§çš„ I/O äº‹ä»¶ç±»å‹ï¼š

```mermaid
graph TD
    A[ç½‘ç»œI/Oäº‹ä»¶] --> B[å¯è¯»äº‹ä»¶]
    A --> C[å¯å†™äº‹ä»¶]
    A --> D[é”™è¯¯äº‹ä»¶]
    A --> E[æŒ‚èµ·äº‹ä»¶]

    B --> B1[æ•°æ®åˆ°è¾¾]
    B --> B2[æ–°è¿æ¥è¯·æ±‚]
    B --> B3[å¯¹ç«¯å…³é—­]

    C --> C1[ç¼“å†²åŒºæœ‰ç©ºé—´]
    C --> C2[è¿æ¥å»ºç«‹å®Œæˆ]

    D --> D1[è¿æ¥å¼‚å¸¸]
    D --> D2[åè®®é”™è¯¯]

    E --> E1[å¯¹ç«¯ä¸»åŠ¨å…³é—­]
    E --> E2[è¿æ¥æ–­å¼€]
```

#### å¯è¯»äº‹ä»¶ï¼ˆRead Eventï¼‰
- **å®šä¹‰**: æ•°æ®åˆ°è¾¾ï¼Œå¯ä»¥è¯»å–
- **åœºæ™¯**:
  - æ¥æ”¶åˆ°ç½‘ç»œæ•°æ®
  - æ–°çš„è¿æ¥è¯·æ±‚ï¼ˆç›‘å¬å¥—æ¥å­—ï¼‰
  - å¯¹ç«¯å…³é—­è¿æ¥ï¼ˆè¯»å–è¿”å›0ï¼‰

#### å¯å†™äº‹ä»¶ï¼ˆWrite Eventï¼‰
- **å®šä¹‰**: ç¼“å†²åŒºæœ‰ç©ºé—´ï¼Œå¯ä»¥å†™å…¥æ•°æ®
- **åœºæ™¯**:
  - å‘é€ç¼“å†²åŒºæœ‰ç©ºé—´
  - éé˜»å¡è¿æ¥å»ºç«‹å®Œæˆ

#### é”™è¯¯äº‹ä»¶ï¼ˆError Eventï¼‰
- **å®šä¹‰**: è¿æ¥å‡ºç°é”™è¯¯
- **åœºæ™¯**:
  - ç½‘ç»œè¿æ¥å¼‚å¸¸
  - åè®®é”™è¯¯
  - èµ„æºä¸è¶³

#### æŒ‚èµ·äº‹ä»¶ï¼ˆHangup Eventï¼‰
- **å®šä¹‰**: è¿æ¥è¢«å¯¹ç«¯å…³é—­
- **åœºæ™¯**:
  - å¯¹ç«¯ä¸»åŠ¨å…³é—­è¿æ¥
  - è¿æ¥æ–­å¼€

### 2.2 ğŸ“ æ–‡ä»¶I/Oäº‹ä»¶

```mermaid
graph LR
    A[æ–‡ä»¶I/Oäº‹ä»¶] --> B[è¯»å†™äº‹ä»¶]
    A --> C[çŠ¶æ€å˜åŒ–]

    B --> B1[æ–‡ä»¶å¯è¯»]
    B --> B2[æ–‡ä»¶å¯å†™]

    C --> C1[æ–‡ä»¶ä¿®æ”¹]
    C --> C2[æ–‡ä»¶åˆ é™¤]
    C --> C3[æƒé™å˜åŒ–]
```

#### è¯»å†™äº‹ä»¶
- **æ–‡ä»¶å¯è¯»**: æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¿›è¡Œè¯»æ“ä½œ
- **æ–‡ä»¶å¯å†™**: æ–‡ä»¶æè¿°ç¬¦å¯ä»¥è¿›è¡Œå†™æ“ä½œ

#### çŠ¶æ€å˜åŒ–äº‹ä»¶
- **æ–‡ä»¶ä¿®æ”¹**: æ–‡ä»¶å†…å®¹è¢«ä¿®æ”¹
- **æ–‡ä»¶åˆ é™¤**: æ–‡ä»¶è¢«åˆ é™¤
- **æƒé™å˜åŒ–**: æ–‡ä»¶æƒé™æˆ–æ‰€æœ‰è€…æ”¹å˜

### 2.3 ğŸ”Œ è®¾å¤‡I/Oäº‹ä»¶

```mermaid
graph TD
    A[è®¾å¤‡I/Oäº‹ä»¶] --> B[ç»ˆç«¯äº‹ä»¶]
    A --> C[ä¸²å£äº‹ä»¶]
    A --> D[ç¡¬ä»¶è®¾å¤‡äº‹ä»¶]

    B --> B1[é”®ç›˜è¾“å…¥]
    B --> B2[é¼ æ ‡äº‹ä»¶]

    C --> C1[ä¸²å£æ•°æ®åˆ°è¾¾]
    C --> C2[ä¸²å£å¯å‘é€]

    D --> D1[USBè®¾å¤‡æ’æ‹”]
    D --> D2[ç¡¬ä»¶çŠ¶æ€å˜åŒ–]
```

### 2.4 â° å®šæ—¶å™¨äº‹ä»¶

```mermaid
graph LR
    A[å®šæ—¶å™¨äº‹ä»¶] --> B[è¶…æ—¶äº‹ä»¶]

    B --> B1[å•æ¬¡å®šæ—¶å™¨]
    B --> B2[å‘¨æœŸæ€§å®šæ—¶å™¨]
    B --> B3[ç›¸å¯¹å®šæ—¶å™¨]
    B --> B4[ç»å¯¹å®šæ—¶å™¨]
```

### 2.5 ğŸ“¢ ä¿¡å·äº‹ä»¶

```mermaid
graph TD
    A[ä¿¡å·äº‹ä»¶] --> B[ç³»ç»Ÿä¿¡å·]
    A --> C[ç”¨æˆ·è‡ªå®šä¹‰ä¿¡å·]

    B --> B1[SIGTERM]
    B --> B2[SIGINT]
    B --> B3[SIGKILL]
    B --> B4[SIGUSR1]
    B --> B5[SIGUSR2]
```

---

## 3. ğŸŒ ç½‘ç»œç¼–ç¨‹ä¸­çš„I/Oäº‹ä»¶

### 3.1 ğŸ“‹ äº‹ä»¶ç±»å‹è¯¦è§£

#### 1. å¯è¯»äº‹ä»¶ï¼ˆPOLLIN/POLLPRIï¼‰

```c
// ä½¿ç”¨ poll ç›‘å¬å¯è¯»äº‹ä»¶
struct pollfd fds[1];
fds[0].fd = sockfd;
fds[0].events = POLLIN;  // ç›‘å¬å¯è¯»äº‹ä»¶

int ret = poll(fds, 1, timeout);

if (fds[0].revents & POLLIN) {
    // å¤„ç†å¯è¯»äº‹ä»¶
    handle_read_event(sockfd);
}
```

**è¡¨ç¤ºçš„æƒ…å†µ**:
- âœ… æœ‰æ–°æ•°æ®åˆ°è¾¾ï¼Œå¯ä»¥è¯»å–
- âœ… æ–°çš„è¿æ¥è¯·æ±‚åˆ°è¾¾ï¼ˆå¯¹äºç›‘å¬å¥—æ¥å­—ï¼‰
- âœ… å¯¹ç«¯å…³é—­è¿æ¥ï¼ˆè¯»å–æ—¶ä¼šè¿”å›0ï¼‰

#### 2. å¯å†™äº‹ä»¶ï¼ˆPOLLOUTï¼‰

```c
// ç›‘å¬å¯å†™äº‹ä»¶
struct pollfd fds[1];
fds[0].fd = sockfd;
fds[0].events = POLLOUT;  // ç›‘å¬å¯å†™äº‹ä»¶

int ret = poll(fds, 1, timeout);

if (fds[0].revents & POLLOUT) {
    // å¤„ç†å¯å†™äº‹ä»¶
    handle_write_event(sockfd);
}
```

**è¡¨ç¤ºçš„æƒ…å†µ**:
- âœ… å‘é€ç¼“å†²åŒºæœ‰ç©ºé—´
- âœ… è¿æ¥å»ºç«‹å®Œæˆï¼ˆå¯¹äºéé˜»å¡è¿æ¥ï¼‰

#### 3. é”™è¯¯äº‹ä»¶ï¼ˆPOLLERRï¼‰

```c
// æ£€æŸ¥é”™è¯¯äº‹ä»¶
if (fds[0].revents & POLLERR) {
    // å¤„ç†é”™è¯¯äº‹ä»¶
    handle_error_event(sockfd);
}
```

**è¡¨ç¤ºçš„æƒ…å†µ**:
- âŒ è¿æ¥å¼‚å¸¸
- âŒ åè®®é”™è¯¯
- âŒ ç½‘ç»œä¸å¯è¾¾

#### 4. æŒ‚èµ·äº‹ä»¶ï¼ˆPOLLHUPï¼‰

```c
// æ£€æŸ¥æŒ‚èµ·äº‹ä»¶
if (fds[0].revents & POLLHUP) {
    // å¤„ç†è¿æ¥å…³é—­
    handle_hangup_event(sockfd);
}
```

**è¡¨ç¤ºçš„æƒ…å†µ**:
- âš ï¸ å¯¹ç«¯ä¸»åŠ¨å…³é—­è¿æ¥
- âš ï¸ è¿æ¥æ–­å¼€

#### 5. æ— æ•ˆäº‹ä»¶ï¼ˆPOLLNVALï¼‰

```c
// æ£€æŸ¥æ— æ•ˆäº‹ä»¶
if (fds[0].revents & POLLNVAL) {
    // å¤„ç†æ— æ•ˆæ–‡ä»¶æè¿°ç¬¦
    handle_invalid_event(sockfd);
}
```

**è¡¨ç¤ºçš„æƒ…å†µ**:
- âŒ æ–‡ä»¶æè¿°ç¬¦æœªæ‰“å¼€æˆ–å·²å…³é—­

### 3.2 ğŸ”„ äº‹ä»¶å¤„ç†æµç¨‹

```mermaid
sequenceDiagram
    participant App as åº”ç”¨ç¨‹åº
    participant Kernel as å†…æ ¸
    participant Network as ç½‘ç»œ

    App->>Kernel: poll/epoll_wait
    Kernel->>Network: ç›‘å¬äº‹ä»¶
    Network->>Kernel: äº‹ä»¶å‘ç”Ÿ
    Kernel->>App: è¿”å›å°±ç»ªäº‹ä»¶
    App->>App: å¤„ç†äº‹ä»¶
    App->>Kernel: ç»§ç»­ç›‘å¬
```

---

## 4. ğŸ’¡ äº‹ä»¶å¤„ç†æœ€ä½³å®è·µ

### 4.1 ğŸ¯ äº‹ä»¶å¤„ç†ç­–ç•¥

```c
// äº‹ä»¶å¤„ç†çš„æœ€ä½³å®è·µç¤ºä¾‹
void handle_events(struct pollfd *fds, int nfds) {
    for (int i = 0; i < nfds; i++) {
        int fd = fds[i].fd;
        short revents = fds[i].revents;

        if (revents == 0) continue;  // æ— äº‹ä»¶

        // ä¼˜å…ˆå¤„ç†é”™è¯¯å’ŒæŒ‚èµ·äº‹ä»¶
        if (revents & POLLNVAL) {
            close(fd);
            continue;
        }

        if (revents & POLLERR) {
            handle_socket_error(fd);
            continue;
        }

        if (revents & POLLHUP) {
            handle_socket_hangup(fd);
            continue;
        }

        // å¤„ç†å¯è¯»äº‹ä»¶
        if (revents & POLLIN) {
            handle_read_event(fd);
        }

        // å¤„ç†å¯å†™äº‹ä»¶
        if (revents & POLLOUT) {
            handle_write_event(fd);
        }

        // å¤„ç†ç´§æ€¥æ•°æ®
        if (revents & POLLPRI) {
            handle_urgent_data(fd);
        }
    }
}
```

### 4.2 âš ï¸ æ³¨æ„äº‹é¡¹

1. **äº‹ä»¶ä¼˜å…ˆçº§**: é”™è¯¯äº‹ä»¶ > æŒ‚èµ·äº‹ä»¶ > è¯»å†™äº‹ä»¶
2. **è¾¹ç¼˜è§¦å‘**: ä½¿ç”¨ ET æ¨¡å¼æ—¶è¦ç¡®ä¿å¤„ç†å®Œæ‰€æœ‰æ•°æ®
3. **èµ„æºç®¡ç†**: åŠæ—¶å…³é—­æ— æ•ˆçš„æ–‡ä»¶æè¿°ç¬¦
4. **æ€§èƒ½ä¼˜åŒ–**: é¿å…ä¸å¿…è¦çš„äº‹ä»¶ç›‘å¬

### 4.3 ğŸ”§ å¸¸è§é—®é¢˜è§£å†³

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| **CPUå ç”¨è¿‡é«˜** | å¿™ç­‰å¾…æˆ–äº‹ä»¶å¤„ç†ä¸å½“ | ä½¿ç”¨é˜»å¡I/Oæˆ–ä¼˜åŒ–äº‹ä»¶å¾ªç¯ |
| **äº‹ä»¶ä¸¢å¤±** | è¾¹ç¼˜è§¦å‘æ¨¡å¼å¤„ç†ä¸å®Œæ•´ | ä½¿ç”¨æ°´å¹³è§¦å‘æˆ–ç¡®ä¿æ•°æ®è¯»å®Œ |
| **è¿æ¥æ³„æ¼** | é”™è¯¯äº‹ä»¶å¤„ç†ä¸å½“ | åŠæ—¶æ¸…ç†å’Œå…³é—­è¿æ¥ |

---

## ğŸ“Š æ€»ç»“

### âœ… æ ¸å¿ƒè¦ç‚¹

- **I/Oäº‹ä»¶åˆ†ç±»**: ç½‘ç»œã€æ–‡ä»¶ã€è®¾å¤‡ã€å®šæ—¶å™¨ã€ä¿¡å·
- **ç½‘ç»œäº‹ä»¶å¤„ç†**: å¯è¯»ã€å¯å†™ã€é”™è¯¯ã€æŒ‚èµ·ã€æ— æ•ˆ
- **æœ€ä½³å®è·µ**: äº‹ä»¶ä¼˜å…ˆçº§ã€èµ„æºç®¡ç†ã€æ€§èƒ½ä¼˜åŒ–

### ğŸ¯ å®é™…åº”ç”¨

- **WebæœåŠ¡å™¨**: å¤„ç†HTTPè¯·æ±‚å’Œå“åº”
- **ä»£ç†æœåŠ¡å™¨**: è½¬å‘å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨æ•°æ®
- **èŠå¤©åº”ç”¨**: å®æ—¶æ¶ˆæ¯ä¼ è¾“
- **æ–‡ä»¶ç›‘æ§**: ç›‘æ§æ–‡ä»¶ç³»ç»Ÿå˜åŒ–

### ğŸ“š æ‰©å±•å­¦ä¹ 

- [Linux I/O å¤šè·¯å¤ç”¨](https://man7.org/linux/man-pages/man2/poll.2.html)
- [epoll ç¼–ç¨‹æŒ‡å—](https://man7.org/linux/man-pages/man7/epoll.7.html)
- [é«˜æ€§èƒ½ç½‘ç»œç¼–ç¨‹](https://github.com/ideawu/immerse)

---

> **ğŸ’¡ æç¤º**: åœ¨å®é™…å¼€å‘ä¸­ï¼Œå»ºè®®ä½¿ç”¨æˆç†Ÿçš„ç½‘ç»œåº“ï¼ˆå¦‚ libeventã€libuvï¼‰æ¥å¤„ç†å¤æ‚çš„äº‹ä»¶ç®¡ç†ï¼Œè¿™äº›åº“å·²ç»å¤„ç†äº†å¤§éƒ¨åˆ†è¾¹ç•Œæƒ…å†µå’Œä¼˜åŒ–ã€‚